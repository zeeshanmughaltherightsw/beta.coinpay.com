(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["account-pos-tickets"],{"154e":function(e,t,c){"use strict";c.r(t);var o=c("f2bf");const a=e=>(Object(o["pushScopeId"])("data-v-682010da"),e=e(),Object(o["popScopeId"])(),e),s={class:"card"},r={class:"body"},n={class:"flex items-center justify-end flex-col lg:flex-row mb-3"},l={class:"mb-4 lg:mb-0 mr-3"},i=a(()=>Object(o["createElementVNode"])("option",{value:""},"All Tickets",-1)),d=a(()=>Object(o["createElementVNode"])("option",{value:"waiting"},"Active",-1)),u=a(()=>Object(o["createElementVNode"])("option",{value:"paid"},"Processed",-1)),m=[i,d,u],b={class:"mb-3 lg:mb-0 mr-3"},p={class:"relative flex-1"},j={class:"text-right"},O={class:"w-full scrollbar scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200 dark:scrollbar-track-gray-900 dark:scrollbar-thumb-gray-600"},k={class:"table-sm mb-2"},w=a(()=>Object(o["createElementVNode"])("thead",null,[Object(o["createElementVNode"])("tr",null,[Object(o["createElementVNode"])("th",{class:"whitespace-nowrap"},"Ticket #"),Object(o["createElementVNode"])("th",{class:"whitespace-nowrap"},"Name"),Object(o["createElementVNode"])("th",null,"Note"),Object(o["createElementVNode"])("th",null,"Cashier"),Object(o["createElementVNode"])("th",null,"Currency"),Object(o["createElementVNode"])("th",{class:"whitespace-nowrap"},"Products"),Object(o["createElementVNode"])("th",{class:"whitespace-nowrap"},"Total"),Object(o["createElementVNode"])("th",{class:"whitespace-nowrap"},"Status"),Object(o["createElementVNode"])("th",{style:{"min-width":"200px",width:"200px"}},"Actions")])],-1)),y=["data-ticket","onDblclick"],h={class:"flex items-center"},v={class:"mr-2"},N={key:0},f=["onClick"],E={class:"pr-3"},g=["onClick"],C=["onClick"],V=["onClick"],x={key:0},S=a(()=>Object(o["createElementVNode"])("td",{colspan:"8"},"No ticket available",-1)),B=[S];function L(e,t,c,a,i,d){const u=Object(o["resolveComponent"])("icon"),S=Object(o["resolveComponent"])("j-button"),L=Object(o["resolveComponent"])("router-link"),T=Object(o["resolveComponent"])("pos-layout"),A=Object(o["resolveComponent"])("save-ticket-modal"),D=Object(o["resolveDirective"])("tippy");return Object(o["openBlock"])(),Object(o["createElementBlock"])(o["Fragment"],null,[Object(o["createVNode"])(T,null,{content:Object(o["withCtx"])(()=>[Object(o["createElementVNode"])("div",s,[Object(o["createElementVNode"])("div",r,[Object(o["createElementVNode"])("div",n,[Object(o["createElementVNode"])("div",l,[Object(o["withDirectives"])(Object(o["createElementVNode"])("select",{"onUpdate:modelValue":t[0]||(t[0]=t=>e.status=t),"aria-label":"",class:"form-select w-72"},m,512),[[o["vModelSelect"],e.status]])]),Object(o["createElementVNode"])("div",b,[Object(o["createElementVNode"])("div",p,[Object(o["createVNode"])(u,{classes:"absolute w-5 h-5 top-3 left-3 dark:text-gray-300",name:"search"}),Object(o["withDirectives"])(Object(o["createElementVNode"])("input",{"onUpdate:modelValue":t[1]||(t[1]=t=>e.keyword=t),"aria-label":"Search...",class:"form-input px-10 w-full",type:"text"},null,512),[[o["vModelText"],e.keyword]]),""!==e.keyword?(Object(o["openBlock"])(),Object(o["createElementBlock"])("span",{key:0,class:"absolute top-3 right-3 dark:text-gray-400 cursor-pointer",onClick:t[2]||(t[2]=t=>e.keyword="")},[Object(o["createVNode"])(u,{classes:"w-5 h-5",name:"close"})])):Object(o["createCommentVNode"])("",!0)])]),Object(o["createElementVNode"])("div",j,[Object(o["createVNode"])(S,{type:"button",onClick:t[3]||(t[3]=e=>a.launchSaveTicketModal())},{default:Object(o["withCtx"])(()=>[Object(o["createTextVNode"])(Object(o["toDisplayString"])(a.translate("pos.tickets.add")),1)]),_:1})])]),Object(o["createElementVNode"])("div",O,[Object(o["createElementVNode"])("table",k,[w,Object(o["createElementVNode"])("tbody",null,[(Object(o["openBlock"])(!0),Object(o["createElementBlock"])(o["Fragment"],null,Object(o["renderList"])(a.filteredTickets,(t,c)=>(Object(o["openBlock"])(),Object(o["createElementBlock"])("tr",{key:c,"data-ticket":c,onDblclick:e=>a.addProductsToTicket(t)},[Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])("#"+t.ticketId),1),Object(o["createElementVNode"])("td",null,[Object(o["createElementVNode"])("div",h,[Object(o["createElementVNode"])("span",v,Object(o["toDisplayString"])(t.name),1),"true"===t.isActive&&e.employee&&t.cashier.toLowerCase()===e.employee.USERNAME.toLowerCase()?(Object(o["openBlock"])(),Object(o["createElementBlock"])("span",N,[Object(o["createVNode"])(u,{classes:"w-5 h-5 text-blue-500",name:"shopping-cart"})])):Object(o["createCommentVNode"])("",!0),"false"===t.isActive&&"paid"!==t.status&&e.employee&&t.cashier===e.employee.USERNAME.toLowerCase()?(Object(o["openBlock"])(),Object(o["createElementBlock"])("span",{key:1,class:"cursor-pointer",onClick:e=>a.updateSelectedTicket(t)},[Object(o["createVNode"])(u,{classes:"w-5 h-5 text-gray-500 opacity-40",name:"shopping-cart"})],8,f)):Object(o["createCommentVNode"])("",!0)])]),Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])(t.notes),1),Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])(t.cashier),1),Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])(t.currency),1),Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])(t.ticketProducts.length),1),Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])(a.totalAmount(t)+" "+a.currency),1),Object(o["createElementVNode"])("td",null,Object(o["toDisplayString"])(t.status),1),Object(o["createElementVNode"])("td",E,["inprogress"===t.status&&null!==t.paymentRequest?Object(o["withDirectives"])((Object(o["openBlock"])(),Object(o["createBlock"])(L,{key:0,to:{name:"account-pos-invoice",params:{confirmCode:t.paymentRequest.Security}},class:"hover:text-blue-500 mr-2 inline-block",tag:"a"},{default:Object(o["withCtx"])(()=>[Object(o["createVNode"])(u,{name:"clock"})]),_:2},1032,["to"])),[[D,"View Invoice"]]):Object(o["createCommentVNode"])("",!0),Object(o["withDirectives"])((Object(o["openBlock"])(),Object(o["createBlock"])(L,{to:{name:"account-pos-ticket",params:{ticketId:t.ticketId}},class:"hover:text-green-500 mr-2 inline-block",tag:"a"},{default:Object(o["withCtx"])(()=>[Object(o["createVNode"])(u,{name:"eye"})]),_:2},1032,["to"])),[[D,"View Detail"]]),e.employee&&e.employee.USERNAME.toLowerCase()===t.cashier.toLowerCase()?(Object(o["openBlock"])(),Object(o["createElementBlock"])(o["Fragment"],{key:1},["paid"!==t.status?Object(o["withDirectives"])((Object(o["openBlock"])(),Object(o["createElementBlock"])("button",{key:0,class:"hover:text-green-500 mr-2",onClick:e=>a.continueShopping(t)},[Object(o["createVNode"])(u,{name:"plus-circle"})],8,g)),[[D,"Add Product(s)"]]):Object(o["createCommentVNode"])("",!0),e.employee&&"paid"!==t.status?(Object(o["openBlock"])(),Object(o["createElementBlock"])(o["Fragment"],{key:1},[Object(o["withDirectives"])((Object(o["openBlock"])(),Object(o["createElementBlock"])("button",{class:"hover:text-green-500 mr-2",onClick:e=>a.launchSaveTicketModal(t)},[Object(o["createVNode"])(u,{name:"edit"})],8,C)),[[D,"Update Ticket"]]),Object(o["withDirectives"])((Object(o["openBlock"])(),Object(o["createElementBlock"])("button",{class:"hover:text-red-500",onClick:e=>a.deleteTicket(t.ticketId)},[Object(o["createVNode"])(u,{name:"trash"})],8,V)),[[D,"Delete Ticket"]])],64)):Object(o["createCommentVNode"])("",!0)],64)):Object(o["createCommentVNode"])("",!0)])],40,y))),128)),0===a.filteredTickets.length?(Object(o["openBlock"])(),Object(o["createElementBlock"])("tr",x,B)):Object(o["createCommentVNode"])("",!0)])])])])])]),_:1}),Object(o["createVNode"])(A)],64)}c("14d9");var T=c("66c3"),A=c("4032"),D=c("cdae");const I={class:"flex items-center justify-between"},M={class:"mb-2"},P={class:"flex items-center justify-between mb-1"},R={class:"text-red-700 dark:text-red-400 text-sm"},U={class:"mb-2"},_={class:"flex items-center justify-between mb-1"},q={class:"text-red-700 dark:text-red-400 text-sm"},F={class:"mt-4 text-right"},W={key:0,class:"mr-3"};function J(e,t,c,a,s,r){const n=Object(o["resolveComponent"])("icon"),l=Object(o["resolveComponent"])("j-button"),i=Object(o["resolveComponent"])("modal");return Object(o["openBlock"])(),Object(o["createBlock"])(i,{maxWidth:e.maxWidth,show:e.show,onClose:t[4]||(t[4]=e=>a.closeModal())},{title:Object(o["withCtx"])(()=>[Object(o["createElementVNode"])("div",I,[Object(o["createElementVNode"])("span",null,Object(o["toDisplayString"])(""==e.form.name?a.translate("pos.products.title"):a.translate("pos.products.titleupdate")),1),Object(o["createElementVNode"])("span",{class:"text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 cursor-pointer",onClick:t[0]||(t[0]=e=>a.closeModal())},[Object(o["createVNode"])(n,{name:"close"})])])]),content:Object(o["withCtx"])(()=>[Object(o["createElementVNode"])("form",{onSubmit:t[3]||(t[3]=Object(o["withModifiers"])(e=>a.submit(),["prevent"]))},[Object(o["createElementVNode"])("div",M,[Object(o["createElementVNode"])("div",P,[Object(o["createElementVNode"])("label",null,Object(o["toDisplayString"])(a.translate("pos.tickets.name")),1),Object(o["createElementVNode"])("div",R,Object(o["toDisplayString"])(a.showError(e.errorBag,"name")),1)]),Object(o["withDirectives"])(Object(o["createElementVNode"])("input",{"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.name=t),class:"form-input w-full",type:"text"},null,512),[[o["vModelText"],e.form.name]])]),Object(o["createElementVNode"])("div",U,[Object(o["createElementVNode"])("div",_,[Object(o["createElementVNode"])("label",null,Object(o["toDisplayString"])(a.translate("pos.tickets.note")),1),Object(o["createElementVNode"])("div",q,Object(o["toDisplayString"])(a.showError(e.errorBag,"notes")),1)]),Object(o["withDirectives"])(Object(o["createElementVNode"])("input",{"onUpdate:modelValue":t[2]||(t[2]=t=>e.form.notes=t),class:"form-input w-full",type:"text"},null,512),[[o["vModelText"],e.form.notes]])]),Object(o["createElementVNode"])("div",F,[Object(o["createVNode"])(l,{disabled:e.isProcessing},{default:Object(o["withCtx"])(()=>[e.isProcessing?(Object(o["openBlock"])(),Object(o["createElementBlock"])("div",W,[Object(o["createVNode"])(n,{name:"spinner",classes:"w-4 h-4 text-white"})])):Object(o["createCommentVNode"])("",!0),Object(o["createElementVNode"])("span",null,Object(o["toDisplayString"])(a.translate("pos.products.btn_save")),1)]),_:1},8,["disabled"])])],32)]),_:1},8,["maxWidth","show"])}var Q=c("714b"),Y=c("5502"),z=c("ea45"),G=c("2ef0"),H=c("8923"),K={name:"SaveTicketModal",components:{Modal:Q["a"],Icon:D["a"],JButton:A["a"]},setup(){const e=Object(o["inject"])("translate"),t=Object(o["inject"])("emitter"),c=Object(o["inject"])("toast"),a=Object(Y["b"])(),{showError:s,validate:r}=Object(z["a"])(),n=Object(o["reactive"])({show:!1,maxWidth:"2xl",closeable:!0,ticket:null,currency:"EUR",employee:null,form:{name:"",notes:""},errorBag:{},rules:{name:["required"]},messages:{name:{required:"Ticket name is required"}},isProcessing:!1,isBarcodeScanner:!1}),l=Object(o["computed"])(()=>a.state.pos),i=Object(o["computed"])(()=>a.state.posCalls),d=Object(o["computed"])(()=>a.state.allAltCoins),u=Object(o["computed"])(()=>{const e=G["find"](d.value,{ShortName:n.currency});return e?e.Name:""});Object(o["watch"])(()=>({...n.form}),(e,t)=>{Object.keys(n.errorBag).length>0&&(n.errorBag=r(n.form,n.rules,n.messages))});const m=()=>{n.show=!1},b=()=>{const e=G["cloneDeep"](l.value.tickets);if(e.length>0){const t=G["maxBy"](e,e=>Number(e.ticketId));return(Number(t.ticketId)+1).toString()}return"1"},p=()=>{if(n.errorBag=r(n.form,n.rules,n.messages),0===Object.keys(n.errorBag).length){n.isProcessing=!0;const e=n.form,t=G["cloneDeep"](l.value.tickets);let o=!0;if(n.ticket){let a=G["findIndex"](t,t=>t.name===e.name&&n.ticket.ticketId!==t.ticketId);-1===a?(a=G["findIndex"](t,{ticketId:n.ticket.ticketId}),t.splice(a,1,{...n.ticket,name:e.name,notes:e.notes})):(o=!1,n.isProcessing=!1,c.error("Ticket name already exists!"))}else-1===G["findIndex"](t,{name:e.name})?t.push({ticketId:b(),status:"waiting",notes:e.notes,name:e.name,isActive:"true",cashier:n.employee.USERNAME.toLowerCase(),currency:u.value,inputCurrency:n.currency,ticketProducts:[],paymentRequest:null}):(o=!1,n.isProcessing=!1,c.error("Product with this sku already exists!"));o&&a.dispatch(H["A"],{call:i.value.tickets,data:t}).then(()=>{n.isProcessing=!1;const e=n.ticket?"Ticket updated successfully":"Ticket added successfully";c.success(e),m()}).catch(e=>{console.log(e),n.isProcessing=!1,c.error("Internal Server Error")})}};return Object(o["onBeforeMount"])(()=>{t.on("saveTicketModal",e=>{n.currency=e.currency,n.employee=e.employee,n.ticket=e.ticket||null,n.form={name:n.ticket?n.ticket.name:"",notes:n.ticket?n.ticket.notes:""},n.show=!0})}),{translate:e,...Object(o["toRefs"])(n),showError:s,closeModal:m,submit:p}}},X=c("6b0d"),Z=c.n(X);const $=Z()(K,[["render",J]]);var ee=$,te=c("2e13"),ce=c("6605"),oe={name:"Tickets",components:{SaveTicketModal:ee,"pos-layout":T["a"],JButton:A["a"],Icon:D["a"]},setup(){const e=Object(o["inject"])("translate"),t=Object(o["inject"])("swal"),c=Object(o["inject"])("toast"),a=Object(o["inject"])("emitter"),s=Object(Y["b"])(),r=Object(ce["e"])(),{toFixed:n}=Object(te["a"])(),l=Object(o["reactive"])({status:"waiting",keyword:"",employee:null,socket:null,isSocketClosed:!1}),i=Object(o["computed"])(()=>s.state.user),d=Object(o["computed"])(()=>s.state.accountInfo),u=Object(o["computed"])(()=>s.state.pos),m=Object(o["computed"])(()=>s.state.posCalls),b=Object(o["computed"])(()=>{let e=[];if(l.employee&&(e=u.value.tickets.filter(e=>"true"===e.isActive&&e.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase())),e.length>1){let e=0;u.value.tickets.map(t=>("true"===t.isActive&&("paid"===t.status?t.isActive="false":e++),e>1&&(t.isActive="false"),t)),e>1&&s.dispatch(H["A"],{call:m.value.tickets,data:u.value.tickets})}if(l.keyword&&l.status){const t=l.keyword.trim().toLowerCase();e=u.value.tickets.filter(e=>"waiting"===l.status.toString()?("undefined"===typeof e.status||-1!==["waiting","inprogress"].indexOf(e.status.toLowerCase()))&&(G["includes"](e.name.toLowerCase(),t)||G["includes"](e.notes.toLowerCase(),t))&&e.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase():e.status&&e.status.toString()===l.status.toString()&&(G["includes"](e.name.toLowerCase(),t)||G["includes"](e.notes.toLowerCase(),t))&&e.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase())}else if(l.keyword){const t=l.keyword.trim().toLowerCase();e=u.value.tickets.filter(e=>G["includes"](e.name.toLowerCase(),t)||G["includes"](e.notes.toLowerCase(),t))}else e=l.status?u.value.tickets.filter(e=>"waiting"===l.status.toString()?("undefined"===typeof e.status||-1!==["waiting","inprogress"].indexOf(e.status.toLowerCase()))&&e.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase():e.status&&e.status.toString()===l.status.toString()&&e.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase()):u.value.tickets;return G["orderBy"](e,[e=>{var t;return new Date(null===(t=e.paymentRequest)||void 0===t?void 0:t.TransactionConfirmedOn)},"isActive"],["desc","desc"])}),p=Object(o["computed"])(()=>d.value?d.value.PayoutCurrencyShortName:"EUR"),j=e=>{let t=0;return e.ticketProducts.map(e=>{t=Number(t)+Number(e.productQuantity)*Number(e.productPrice)}),n(t)},O=(e,t=!1)=>{const o=G["cloneDeep"](u.value.tickets);l.employee&&e.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase()&&(o.map(t=>{t.cashier.toLowerCase()===l.employee.USERNAME.toLowerCase()&&(t.isActive=t.ticketId.toString()===e.ticketId.toString()&&"paid"!==t.status?"true":"false")}),s.dispatch(H["A"],{call:m.value.tickets,data:o}),c.success("Ticket selected successfully"),t&&r.push({name:"account-pos-products"}))},k=e=>{O(e,!0)},w=e=>{"paid"!==e.status&&l.employee&&l.employee.USERNAME.toLowerCase()===e.cashier.toLowerCase()&&k(e)},y=e=>{const c=G["findIndex"](u.value.tickets,{ticketId:e});-1!==c&&t.fire({title:"Ticket",text:"Are you sure, want to delete this ticket?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes",cancelButtonText:"No",focusCancel:!0,customClass:{container:"swal2-tailwind"}}).then(({value:e})=>{if(e&&!0===e){const e=G["cloneDeep"](u.value),t=e.tickets,o=t[c],a=e.products,r=o.isActive;if(o.ticketProducts.length>0&&o.ticketProducts.map(t=>{const c=G["findIndex"](a,{id:t.productId});-1!==c&&(a[c].stock=Number(a[c].stock)+Number(t.productQuantity));const o=G["findIndex"](e.favourites,{id:t.productId});-1!==o&&(e.favourites[o].stock=Number(e.favourites[o].stock)+Number(t.productQuantity))}),s.dispatch(H["w"],{call:m.value.products,data:a}),e.products=a,t.splice(c,1),e.tickets=t,"true"===r&&e.tickets.length>0){const t=G["findIndex"](e.tickets,e=>("waiting"===e.status.toLowerCase()||"inprogress"===e.status.toLowerCase())&&e.cashier===l.employee.USERNAME.toLowerCase());-1!==t&&(e.tickets[t].isActive="true")}s.dispatch(H["A"],{call:m.value.tickets,data:e.tickets})}})},h=(e=null)=>{a.emit("saveTicketModal",{currency:p.value,employee:l.employee,ticket:e})},v=()=>{l.socket=new WebSocket("wss://wss.cointopay.com/transactions"),l.socket.onmessage=e=>{if(e&&e.data){const t=e.data.split(":");if("pos"===t[0].toLowerCase()){const e=t[1];i.value&&e.toString()===i.value.ID.toString()&&s.dispatch(H["i"],{})}}},l.socket.onclose=e=>{l.isSocketClosed||v()}};return Object(o["onBeforeMount"])(()=>{l.employee=G["find"](u.value.users,{isLoggedIn:"true"}),v()}),Object(o["onBeforeUnmount"])(()=>{l.isSocketClosed=!0,l.socket&&l.socket.close()}),{translate:e,...Object(o["toRefs"])(l),filteredTickets:b,currency:p,totalAmount:j,continueShopping:k,updateSelectedTicket:O,addProductsToTicket:w,deleteTicket:y,launchSaveTicketModal:h}}};c("43dc");const ae=Z()(oe,[["render",L],["__scopeId","data-v-682010da"]]);t["default"]=ae},"43dc":function(e,t,c){"use strict";c("aacb")},aacb:function(e,t,c){}}]);
//# sourceMappingURL=account-pos-tickets.a455d8cf.js.map