"use strict";(self["webpackChunkcointopay"]=self["webpackChunkcointopay"]||[]).push([[156],{9973:function(e,t,o){o.r(t),o.d(t,{default:function(){return ae}});var s=o(821);const a=e=>((0,s.pushScopeId)("data-v-4733e418"),e=e(),(0,s.popScopeId)(),e),c={class:"card"},r={class:"body"},l={class:"flex items-center justify-end flex-col lg:flex-row mb-3"},n={class:"mb-4 lg:mb-0 mr-3"},i=a((()=>(0,s.createElementVNode)("option",{value:""},"All Tickets",-1))),d=a((()=>(0,s.createElementVNode)("option",{value:"waiting"},"Active",-1))),u=a((()=>(0,s.createElementVNode)("option",{value:"paid"},"Processed",-1))),m=[i,d,u],p={class:"mb-3 lg:mb-0 mr-3"},k={class:"relative flex-1"},y={class:"text-right"},h={class:"w-full scrollbar scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200 dark:scrollbar-track-gray-900 dark:scrollbar-thumb-gray-600"},w={class:"table-sm mb-2"},v=a((()=>(0,s.createElementVNode)("thead",null,[(0,s.createElementVNode)("tr",null,[(0,s.createElementVNode)("th",{class:"whitespace-nowrap"},"Ticket Number"),(0,s.createElementVNode)("th",{class:"whitespace-nowrap"},"Ticket Name"),(0,s.createElementVNode)("th",null,"Note"),(0,s.createElementVNode)("th",null,"Cashier"),(0,s.createElementVNode)("th",null,"Currency"),(0,s.createElementVNode)("th",{class:"whitespace-nowrap"},"Total Products"),(0,s.createElementVNode)("th",{class:"whitespace-nowrap"},"Total Amount"),(0,s.createElementVNode)("th",{style:{"min-width":"200px",width:"200px"}},"Actions")])],-1))),N=["data-ticket","onDblclick"],E={class:"flex items-center"},f={class:"mr-2"},g={key:0},C=["onClick"],V={class:"pr-3"},x=["onClick"],b=["onClick"],S=["onClick"],B={key:0},L=a((()=>(0,s.createElementVNode)("td",{colspan:"8"},"No ticket available",-1))),T=[L];function A(e,t,o,a,i,d){const u=(0,s.resolveComponent)("icon"),L=(0,s.resolveComponent)("j-button"),A=(0,s.resolveComponent)("router-link"),D=(0,s.resolveComponent)("pos-layout"),I=(0,s.resolveComponent)("save-ticket-modal"),M=(0,s.resolveDirective)("tippy");return(0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,null,[(0,s.createVNode)(D,null,{content:(0,s.withCtx)((()=>[(0,s.createElementVNode)("div",c,[(0,s.createElementVNode)("div",r,[(0,s.createElementVNode)("div",l,[(0,s.createElementVNode)("div",n,[(0,s.withDirectives)((0,s.createElementVNode)("select",{"onUpdate:modelValue":t[0]||(t[0]=t=>e.status=t),"aria-label":"",class:"form-select w-72"},m,512),[[s.vModelSelect,e.status]])]),(0,s.createElementVNode)("div",p,[(0,s.createElementVNode)("div",k,[(0,s.createVNode)(u,{classes:"absolute w-5 h-5 top-3 left-3 dark:text-gray-300",name:"search"}),(0,s.withDirectives)((0,s.createElementVNode)("input",{"onUpdate:modelValue":t[1]||(t[1]=t=>e.keyword=t),"aria-label":"Search...",class:"form-input px-10 w-full",type:"text"},null,512),[[s.vModelText,e.keyword]]),""!==e.keyword?((0,s.openBlock)(),(0,s.createElementBlock)("span",{key:0,class:"absolute top-3 right-3 dark:text-gray-400 cursor-pointer",onClick:t[2]||(t[2]=t=>e.keyword="")},[(0,s.createVNode)(u,{classes:"w-5 h-5",name:"close"})])):(0,s.createCommentVNode)("",!0)])]),(0,s.createElementVNode)("div",y,[(0,s.createVNode)(L,{type:"button",onClick:t[3]||(t[3]=e=>a.launchSaveTicketModal())},{default:(0,s.withCtx)((()=>[(0,s.createTextVNode)((0,s.toDisplayString)(a.translate("pos.tickets.add")),1)])),_:1})])]),(0,s.createElementVNode)("div",h,[(0,s.createElementVNode)("table",w,[v,(0,s.createElementVNode)("tbody",null,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(a.filteredTickets,((t,o)=>((0,s.openBlock)(),(0,s.createElementBlock)("tr",{key:o,"data-ticket":o,onDblclick:e=>a.addProductsToTicket(t)},[(0,s.createElementVNode)("td",null,(0,s.toDisplayString)(`#${t.ticketId}`),1),(0,s.createElementVNode)("td",null,[(0,s.createElementVNode)("div",E,[(0,s.createElementVNode)("span",f,(0,s.toDisplayString)(t.name),1),"true"===t.isActive&&e.employee&&t.cashier.toLowerCase()===e.employee.USERNAME.toLowerCase()?((0,s.openBlock)(),(0,s.createElementBlock)("span",g,[(0,s.createVNode)(u,{classes:"w-5 h-5 text-blue-500",name:"shopping-cart"})])):(0,s.createCommentVNode)("",!0),"false"===t.isActive&&"paid"!==t.status&&e.employee&&t.cashier===e.employee.USERNAME.toLowerCase()?((0,s.openBlock)(),(0,s.createElementBlock)("span",{key:1,class:"cursor-pointer",onClick:e=>a.updateSelectedTicket(t)},[(0,s.createVNode)(u,{classes:"w-5 h-5 text-gray-500",name:"shopping-cart"})],8,C)):(0,s.createCommentVNode)("",!0)])]),(0,s.createElementVNode)("td",null,(0,s.toDisplayString)(t.notes),1),(0,s.createElementVNode)("td",null,(0,s.toDisplayString)(t.cashier),1),(0,s.createElementVNode)("td",null,(0,s.toDisplayString)(t.currency),1),(0,s.createElementVNode)("td",null,(0,s.toDisplayString)(t.ticketProducts.length),1),(0,s.createElementVNode)("td",null,(0,s.toDisplayString)(a.totalAmount(t)+" "+a.currency),1),(0,s.createElementVNode)("td",V,["inprogress"===t.status&&null!==t.paymentRequest?(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createBlock)(A,{key:0,to:{name:"account-pos-invoice",params:{confirmCode:t.paymentRequest.Security}},class:"hover:text-blue-500 mr-2 inline-block",tag:"a"},{default:(0,s.withCtx)((()=>[(0,s.createVNode)(u,{name:"clock"})])),_:2},1032,["to"])),[[M,"View Invoice"]]):(0,s.createCommentVNode)("",!0),(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createBlock)(A,{to:{name:"account-pos-ticket",params:{ticketId:t.ticketId}},class:"hover:text-green-500 mr-2 inline-block",tag:"a"},{default:(0,s.withCtx)((()=>[(0,s.createVNode)(u,{name:"eye"})])),_:2},1032,["to"])),[[M,"View Detail"]]),e.employee&&e.employee.USERNAME.toLowerCase()===t.cashier.toLowerCase()?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},["paid"!==t.status?(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)("button",{key:0,class:"hover:text-green-500 mr-2",onClick:e=>a.continueShopping(t)},[(0,s.createVNode)(u,{name:"plus-circle"})],8,x)),[[M,"Add Product(s)"]]):(0,s.createCommentVNode)("",!0),e.employee&&"paid"!==t.status?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)("button",{class:"hover:text-green-500 mr-2",onClick:e=>a.launchSaveTicketModal(t)},[(0,s.createVNode)(u,{name:"edit"})],8,b)),[[M,"Update Ticket"]]),(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)("button",{class:"hover:text-red-500",onClick:e=>a.deleteTicket(t.ticketId)},[(0,s.createVNode)(u,{name:"trash"})],8,S)),[[M,"Delete Ticket"]])],64)):(0,s.createCommentVNode)("",!0)],64)):(0,s.createCommentVNode)("",!0)])],40,N)))),128)),0===a.filteredTickets.length?((0,s.openBlock)(),(0,s.createElementBlock)("tr",B,T)):(0,s.createCommentVNode)("",!0)])])])])])])),_:1}),(0,s.createVNode)(I)],64)}var D=o(2630),I=o(3164),M=o(7983);const R={class:"flex items-center justify-between"},P={class:"mb-2"},U={class:"flex items-center justify-between mb-1"},j={class:"text-red-700 dark:text-red-400 text-sm"},Z={class:"mb-2"},F={class:"flex items-center justify-between mb-1"},_={class:"text-red-700 dark:text-red-400 text-sm"},q={class:"mt-4 text-right"},W={key:0,class:"mr-3"};function O(e,t,o,a,c,r){const l=(0,s.resolveComponent)("icon"),n=(0,s.resolveComponent)("j-button"),i=(0,s.resolveComponent)("modal");return(0,s.openBlock)(),(0,s.createBlock)(i,{maxWidth:e.maxWidth,show:e.show,onClose:t[4]||(t[4]=e=>a.closeModal())},{title:(0,s.withCtx)((()=>[(0,s.createElementVNode)("div",R,[(0,s.createElementVNode)("span",null,(0,s.toDisplayString)(a.translate("pos.products.title")),1),(0,s.createElementVNode)("span",{class:"text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 cursor-pointer",onClick:t[0]||(t[0]=e=>a.closeModal())},[(0,s.createVNode)(l,{name:"close"})])])])),content:(0,s.withCtx)((()=>[(0,s.createElementVNode)("form",{onSubmit:t[3]||(t[3]=(0,s.withModifiers)((e=>a.submit()),["prevent"]))},[(0,s.createElementVNode)("div",P,[(0,s.createElementVNode)("div",U,[(0,s.createElementVNode)("label",null,(0,s.toDisplayString)(a.translate("pos.tickets.name")),1),(0,s.createElementVNode)("div",j,(0,s.toDisplayString)(a.showError(e.errorBag,"name")),1)]),(0,s.withDirectives)((0,s.createElementVNode)("input",{"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.name=t),class:"form-input w-full",type:"text"},null,512),[[s.vModelText,e.form.name]])]),(0,s.createElementVNode)("div",Z,[(0,s.createElementVNode)("div",F,[(0,s.createElementVNode)("label",null,(0,s.toDisplayString)(a.translate("pos.tickets.note")),1),(0,s.createElementVNode)("div",_,(0,s.toDisplayString)(a.showError(e.errorBag,"notes")),1)]),(0,s.withDirectives)((0,s.createElementVNode)("input",{"onUpdate:modelValue":t[2]||(t[2]=t=>e.form.notes=t),class:"form-input w-full",type:"text"},null,512),[[s.vModelText,e.form.notes]])]),(0,s.createElementVNode)("div",q,[(0,s.createVNode)(n,{disabled:e.isProcessing},{default:(0,s.withCtx)((()=>[e.isProcessing?((0,s.openBlock)(),(0,s.createElementBlock)("div",W,[(0,s.createVNode)(l,{name:"spinner",classes:"w-4 h-4 text-white"})])):(0,s.createCommentVNode)("",!0),(0,s.createElementVNode)("span",null,(0,s.toDisplayString)(a.translate("pos.products.btn_save")),1)])),_:1},8,["disabled"])])],32)])),_:1},8,["maxWidth","show"])}var Q=o(9099),J=o(8637),Y=o(6232),$=o(6486),z=o(9783),G={name:"SaveTicketModal",components:{Modal:Q.Z,Icon:M.Z,JButton:I.Z},setup(){const e=(0,s.inject)("translate"),t=(0,s.inject)("emitter"),o=(0,s.inject)("toast"),a=(0,J.oR)(),{showError:c,validate:r}=(0,Y.Z)(),l=(0,s.reactive)({show:!1,maxWidth:"2xl",closeable:!0,ticket:null,currency:"EUR",employee:null,form:{name:"",notes:""},errorBag:{},rules:{name:["required"]},messages:{name:{required:"Ticket name is required"}},isProcessing:!1,isBarcodeScanner:!1}),n=(0,s.computed)((()=>a.state.pos)),i=(0,s.computed)((()=>a.state.posCalls)),d=(0,s.computed)((()=>a.state.allAltCoins)),u=(0,s.computed)((()=>{const e=$.find(d.value,{ShortName:l.currency});return e?e.Name:""}));(0,s.watch)((()=>({...l.form})),((e,t)=>{Object.keys(l.errorBag).length>0&&(l.errorBag=r(l.form,l.rules,l.messages))}));const m=()=>{l.show=!1},p=()=>{const e=$.cloneDeep(n.value.tickets);if(e.length>0){const t=$.maxBy(e,(e=>Number(e.id)));return(Number(t.id)+1).toString()}return"1"},k=()=>{if(l.errorBag=r(l.form,l.rules,l.messages),0===Object.keys(l.errorBag).length){l.isProcessing=!0;const e=l.form,t=$.cloneDeep(n.value.tickets);let s=!0;if(l.ticket){let a=$.findIndex(t,(t=>t.name===e.name&&l.ticket.ticketId!==t.ticketId));-1===a?(a=$.findIndex(t,{ticketId:l.ticket.ticketId}),t.splice(a,1,{...l.ticket,name:e.name,notes:e.notes})):(s=!1,l.isProcessing=!1,o.error("Ticket name already exists!"))}else-1===$.findIndex(t,{name:e.name})?t.push({ticketId:p(),status:"waiting",notes:e.notes,name:e.name,isActive:"true",cashier:l.employee.USERNAME.toLowerCase(),currency:u.value,inputCurrency:l.currency,ticketProducts:[],paymentRequest:null}):(s=!1,l.isProcessing=!1,o.error("Product with this sku already exists!"));s&&a.dispatch(z.yF,{call:i.value.tickets,data:t}).then((()=>{l.isProcessing=!1;const e=l.ticket?"Ticket updated successfully":"Ticket added successfully";o.success(e),m()})).catch((e=>{console.log(e),l.isProcessing=!1,o.error("Internal Server Error")}))}};return(0,s.onBeforeMount)((()=>{t.on("saveTicketModal",(e=>{l.currency=e.currency,l.employee=e.employee,l.ticket=e.ticket||null,l.form={name:l.ticket?l.ticket.name:"",notes:l.ticket?l.ticket.notes:""},l.show=!0}))})),{translate:e,...(0,s.toRefs)(l),showError:c,closeModal:m,submit:k}}},H=o(3744);const K=(0,H.Z)(G,[["render",O]]);var X=K,ee=o(4729),te=o(2119),oe={name:"Tickets",components:{SaveTicketModal:X,"pos-layout":D.Z,JButton:I.Z,Icon:M.Z},setup(){const e=(0,s.inject)("translate"),t=(0,s.inject)("swal"),o=(0,s.inject)("toast"),a=(0,s.inject)("emitter"),c=(0,J.oR)(),r=(0,te.tv)(),{toFixed:l}=(0,ee.Z)(),n=(0,s.reactive)({status:"",keyword:"",employee:null,socket:null,isSocketClosed:!1}),i=(0,s.computed)((()=>c.state.user)),d=(0,s.computed)((()=>c.state.accountInfo)),u=(0,s.computed)((()=>c.state.pos)),m=(0,s.computed)((()=>c.state.posCalls)),p=(0,s.computed)((()=>{let e=[];if(n.employee&&(e=u.value.tickets.filter((e=>"true"===e.isActive&&e.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase()))),e.length>1){let e=0;u.value.tickets.map((t=>("true"===t.isActive&&("paid"===t.status?t.isActive="false":e++),e>1&&(t.isActive="false"),t))),e>1&&c.dispatch(z.yF,{call:m.value.tickets,data:u.value.tickets})}if(n.keyword&&n.status){const t=n.keyword.trim().toLowerCase();e=u.value.tickets.filter((e=>"waiting"===n.status.toString()?("undefined"===typeof e.status||-1!==["waiting","inprogress"].indexOf(e.status.toLowerCase()))&&($.includes(e.name.toLowerCase(),t)||$.includes(e.notes.toLowerCase(),t))&&e.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase():e.status&&e.status.toString()===n.status.toString()&&($.includes(e.name.toLowerCase(),t)||$.includes(e.notes.toLowerCase(),t))&&e.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase()))}else if(n.keyword){const t=n.keyword.trim().toLowerCase();e=u.value.tickets.filter((e=>$.includes(e.name.toLowerCase(),t)||$.includes(e.notes.toLowerCase(),t)))}else e=n.status?u.value.tickets.filter((e=>"waiting"===n.status.toString()?("undefined"===typeof e.status||-1!==["waiting","inprogress"].indexOf(e.status.toLowerCase()))&&e.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase():e.status&&e.status.toString()===n.status.toString()&&e.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase())):u.value.tickets;return $.orderBy(e,"isActive","desc")})),k=(0,s.computed)((()=>d.value?d.value.PayoutCurrencyShortName:"EUR")),y=e=>{let t=0;return e.ticketProducts.map((e=>{t=Number(t)+Number(e.productQuantity)*Number(e.productPrice)})),l(t)},h=(e,t=!1)=>{const s=$.cloneDeep(u.value.tickets);n.employee&&e.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase()&&(s.map((t=>{t.cashier.toLowerCase()===n.employee.USERNAME.toLowerCase()&&(t.isActive=t.ticketId.toString()===e.ticketId.toString()&&"paid"!==t.status?"true":"false")})),c.dispatch(z.yF,{call:m.value.tickets,data:s}),o.success("Ticket selected successfully"),t&&r.push({name:"account-pos-products"}))},w=e=>{h(e,!0)},v=e=>{"paid"!==e.status&&n.employee&&n.employee.USERNAME.toLowerCase()===e.cashier.toLowerCase()&&w(e)},N=e=>{const o=$.findIndex(u.value.tickets,{ticketId:e});-1!==o&&t.fire({title:"Ticket",text:"Are you sure, want to delete this ticket?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes",cancelButtonText:"No",focusCancel:!0,customClass:{container:"swal2-tailwind"}}).then((({value:e})=>{if(e&&!0===e){const e=$.cloneDeep(u.value),t=e.tickets,s=t[o],a=e.products,r=s.isActive;if(s.ticketProducts.length>0&&s.ticketProducts.map((t=>{const o=$.findIndex(a,{id:t.productId});-1!==o&&(a[o].stock=Number(a[o].stock)+Number(t.productQuantity));const s=$.findIndex(e.favourites,{id:t.productId});-1!==s&&(e.favourites[s].stock=Number(e.favourites[s].stock)+Number(t.productQuantity))})),c.dispatch(z.Rb,{call:m.value.products,data:a}),e.products=a,t.splice(o,1),e.tickets=t,"true"===r&&e.tickets.length>0){const t=$.findIndex(e.tickets,(e=>("waiting"===e.status.toLowerCase()||"inprogress"===e.status.toLowerCase())&&e.cashier===n.employee.USERNAME.toLowerCase()));-1!==t&&(e.tickets[t].isActive="true")}c.dispatch(z.yF,{call:m.value.tickets,data:e.tickets})}}))},E=(e=null)=>{a.emit("saveTicketModal",{currency:k.value,employee:n.employee,ticket:e})},f=()=>{n.socket=new WebSocket("wss://wss.cointopay.com/transactions"),n.socket.onmessage=e=>{if(e&&e.data){const t=e.data.split(":");if("pos"===t[0].toLowerCase()){const e=t[1];i.value&&e.toString()===i.value.ID.toString()&&c.dispatch(z.Z6,{})}}},n.socket.onclose=e=>{n.isSocketClosed||f()}};return(0,s.onBeforeMount)((()=>{n.employee=$.find(u.value.users,{isLoggedIn:"true"}),f()})),(0,s.onBeforeUnmount)((()=>{n.isSocketClosed=!0,n.socket&&n.socket.close()})),{translate:e,...(0,s.toRefs)(n),filteredTickets:p,currency:k,totalAmount:y,continueShopping:w,updateSelectedTicket:h,addProductsToTicket:v,deleteTicket:N,launchSaveTicketModal:E}}};const se=(0,H.Z)(oe,[["render",A],["__scopeId","data-v-4733e418"]]);var ae=se}}]);
//# sourceMappingURL=account-pos-tickets.294db46e.js.map